# 개선된 한글 지원 모델 적용 가이드

> **목적**: 기존 영어 전용 모델을 한글 지원 다국어 모델로 변경하는 방법

---

## 🎯 개선 모델 적용 방법

### 방법 1: main.py 수정 (권장)

기존 코드를 건드리지 않고 import만 변경하는 방법입니다.

**파일**: `실습결과/src/main.py`

```python
# 기존 코드 (10번째 줄)
from models.sentiment_model import SentimentModel

# 변경 후
from models.sentiment_model_improved import SentimentModelImproved as SentimentModel
```

**적용 순서 (Windows CMD)**:

```cmd
REM 1. 실습결과 폴더로 이동
cd "Side Project\[AI이행파트] Docker에 AI 서비스 환경 구축해보기\실습결과"

REM 2. main.py 백업
copy src\main.py src\main_backup.py

REM 3. main.py 수정 (메모장 또는 VS Code로 편집)
notepad src\main.py

REM 4. 10번째 줄을 다음과 같이 변경:
REM from models.sentiment_model_improved import SentimentModelImproved as SentimentModel

REM 5. 저장 후 서버 실행
cd src
python main.py
```

---

### 방법 2: 파일 교체

개선된 모델을 기본 모델로 교체하는 방법입니다.

```cmd
REM 1. 실습결과 폴더로 이동
cd "Side Project\[AI이행파트] Docker에 AI 서비스 환경 구축해보기\실습결과"

REM 2. 기존 모델 백업
copy src\models\sentiment_model.py src\models\sentiment_model_original.py

REM 3. 개선 모델로 교체
copy src\models\sentiment_model_improved.py src\models\sentiment_model.py

REM 4. 서버 실행
cd src
python main.py
```

---

### 방법 3: endpoints.py 수정

API 엔드포인트에서만 개선 모델 사용하는 방법입니다.

**파일**: `실습결과/src/api/endpoints.py`

```python
# 상단에 추가
from models.sentiment_model_improved import SentimentModelImproved

# predict 함수 수정
@router.post("/predict", response_model=PredictResponse)
async def predict(request: PredictRequest):
    # 개선 모델 사용 (다국어 모드)
    model_improved = SentimentModelImproved(use_multilingual=True)
    result = model_improved.predict(request.text)
    return result
```

---

## 🚀 실행 및 테스트

### 1. 서버 실행 (CMD)

```cmd
cd "Side Project\[AI이행파트] Docker에 AI 서비스 환경 구축해보기\실습결과\src"
python main.py
```

**실행 로그 확인**:
```
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
INFO:     Loading AI model...
INFO:     Loading model: nlptown/bert-base-multilingual-uncased-sentiment
INFO:     Multilingual mode: True
INFO:     Model loaded successfully
INFO:     Model supports: 한글/영어/다국어
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

### 2. PowerShell 테스트

**새 PowerShell 창을 열고** 다음 스크립트 실행:

#### 헬스체크
```powershell
# 헬스체크
Invoke-RestMethod -Uri "http://localhost:8000/health"
```

**예상 출력**:
```
status      : healthy
timestamp   : 2025-10-26T18:00:00.000000
version     : 1.0.0
model_loaded: True
```

#### 한글 긍정 테스트
```powershell
# 한글 긍정 텍스트
$body = @{
    text = "오늘 정말 기분이 좋다!"
} | ConvertTo-Json -Compress

$result = Invoke-RestMethod -Uri "http://localhost:8000/predict" `
    -Method POST `
    -Body $body `
    -ContentType "application/json"

Write-Host "`n=== 한글 긍정 테스트 ===" -ForegroundColor Green
Write-Host "텍스트: 오늘 정말 기분이 좋다!"
Write-Host "감정: $($result.sentiment)"
Write-Host "신뢰도: $($result.confidence)"
Write-Host "처리시간: $($result.processing_time)초"
```

**예상 출력**:
```
=== 한글 긍정 테스트 ===
텍스트: 오늘 정말 기분이 좋다!
감정: positive
신뢰도: 0.92
처리시간: 0.156초
```

#### 한글 부정 테스트
```powershell
# 한글 부정 텍스트
$body = @{
    text = "정말 최악의 하루였어"
} | ConvertTo-Json -Compress

$result = Invoke-RestMethod -Uri "http://localhost:8000/predict" `
    -Method POST `
    -Body $body `
    -ContentType "application/json"

Write-Host "`n=== 한글 부정 테스트 ===" -ForegroundColor Red
Write-Host "텍스트: 정말 최악의 하루였어"
Write-Host "감정: $($result.sentiment)"
Write-Host "신뢰도: $($result.confidence)"
```

**예상 출력**:
```
=== 한글 부정 테스트 ===
텍스트: 정말 최악의 하루였어
감정: negative
신뢰도: 0.88
```

#### 한글 중립 테스트
```powershell
# 한글 중립 텍스트
$body = @{
    text = "오늘 날씨가 흐립니다"
} | ConvertTo-Json -Compress

$result = Invoke-RestMethod -Uri "http://localhost:8000/predict" `
    -Method POST `
    -Body $body `
    -ContentType "application/json"

Write-Host "`n=== 한글 중립 테스트 ===" -ForegroundColor Yellow
Write-Host "텍스트: 오늘 날씨가 흐립니다"
Write-Host "감정: $($result.sentiment)"
Write-Host "신뢰도: $($result.confidence)"
```

#### 영어 테스트
```powershell
# 영어 긍정 텍스트
$body = @{
    text = "I am very happy today!"
} | ConvertTo-Json -Compress

$result = Invoke-RestMethod -Uri "http://localhost:8000/predict" `
    -Method POST `
    -Body $body `
    -ContentType "application/json"

Write-Host "`n=== 영어 긍정 테스트 ===" -ForegroundColor Green
Write-Host "텍스트: I am very happy today!"
Write-Host "감정: $($result.sentiment)"
Write-Host "신뢰도: $($result.confidence)"
```

---

## 📊 비교 테스트 (기존 vs 개선)

### 전체 테스트 스크립트 (PowerShell)

```powershell
# test-sentiment-improved.ps1
Write-Host "================================" -ForegroundColor Cyan
Write-Host "  감정분석 모델 테스트" -ForegroundColor Cyan
Write-Host "================================" -ForegroundColor Cyan

$testCases = @(
    @{ text = "오늘 정말 기분이 좋다!"; expected = "positive" }
    @{ text = "정말 최악의 하루였어"; expected = "negative" }
    @{ text = "오늘 날씨가 흐립니다"; expected = "neutral" }
    @{ text = "I am very happy"; expected = "positive" }
    @{ text = "This is terrible"; expected = "negative" }
    @{ text = "The weather is okay"; expected = "neutral" }
)

$correct = 0
$total = $testCases.Count

foreach ($test in $testCases) {
    $body = @{ text = $test.text } | ConvertTo-Json -Compress

    try {
        $result = Invoke-RestMethod -Uri "http://localhost:8000/predict" `
            -Method POST `
            -Body $body `
            -ContentType "application/json"

        $match = if ($result.sentiment -eq $test.expected) {
            $correct++
            "✅ 정답"
        } else {
            "❌ 오답"
        }

        Write-Host "`n텍스트: $($test.text)" -ForegroundColor White
        Write-Host "예상: $($test.expected) | 결과: $($result.sentiment) | $match"
        Write-Host "신뢰도: $($result.confidence) | 시간: $($result.processing_time)s"
    }
    catch {
        Write-Host "에러: $($_.Exception.Message)" -ForegroundColor Red
    }
}

Write-Host "`n================================" -ForegroundColor Cyan
Write-Host "정확도: $correct / $total ($(($correct/$total*100).ToString('F1'))%)" -ForegroundColor Cyan
Write-Host "================================" -ForegroundColor Cyan
```

**저장**: `실습결과/test-sentiment-improved.ps1`

**실행**:
```powershell
cd "Side Project\[AI이행파트] Docker에 AI 서비스 환경 구축해보기\실습결과"
.\test-sentiment-improved.ps1
```

---

## 🔍 문제 해결

### 1. 모델 다운로드 시간
**증상**: 첫 실행 시 5분 이상 소요

**원인**: 다국어 모델(680MB) 다운로드 중

**해결**:
- 인터넷 연결 확인
- 인내심 가지고 대기
- 다운로드는 한 번만 발생 (이후 캐시 사용)

### 2. 메모리 부족
**증상**: `MemoryError` 또는 프로그램 멈춤

**해결**:
```cmd
REM Python 메모리 제한 늘리기 (PowerShell)
$env:PYTHONMALLOC = "malloc"
python main.py
```

### 3. 모델이 여전히 neutral 판단
**증상**: 한글이 neutral로 나옴

**원인**: 개선 모델이 적용되지 않음

**확인**:
- 서버 로그에서 "Multilingual mode: True" 확인
- main.py import 수정 여부 확인

---

## 📁 파일 구조

```
실습결과/
├── src/
│   ├── main.py (수정 필요)
│   ├── api/
│   │   └── endpoints.py
│   └── models/
│       ├── sentiment_model.py (기존)
│       ├── sentiment_model_improved.py (개선 - 다국어)
│       └── sentiment_model_original.py (백업)
│
├── test-sentiment-improved.ps1 (테스트 스크립트)
└── .env
```

---

## ✅ 체크리스트

### 적용 전
- [ ] Python 3.10+ 설치
- [ ] `pip install -r requirements.txt` 완료
- [ ] 기존 모델 백업 완료

### 적용 후
- [ ] 서버 실행 로그에서 "Multilingual mode: True" 확인
- [ ] 헬스체크 성공 (`model_loaded: True`)
- [ ] 한글 긍정 텍스트가 positive로 판단
- [ ] 한글 부정 텍스트가 negative로 판단
- [ ] 영어 텍스트도 정상 작동

---

## 🎯 다음 단계

1. **테스트 자동화**: pytest로 감정분석 정확도 테스트
2. **API 응답 개선**: 상세 점수 반환 (`predict_with_scores` 사용)
3. **모델 선택 기능**: .env에서 모델 선택 가능하도록 설정
4. **성능 모니터링**: 응답 시간 및 메모리 사용량 로깅

