# 1.3.01. SQLAlchemy 소개

> **작성자**: Bern
> **작성일**: 2025-10-26
> **카테고리**: 데이터베이스

---

## 목차
1. [ORM의 개념](#1-orm의-개념)
2. [SQLAlchemy의 개념](#2-sqlalchemy의-개념)
3. [설치 방법](#3-설치-방법)
4. [데이터베이스 연결](#4-데이터베이스-연결)
5. [실습 코드](#5-실습-코드)

---

## 1. ORM의 개념

### 1.1. ORM이란?

**ORM(Object-Relational Mapping)**은 객체 지향 프로그래밍 언어와 관계형 데이터베이스 간의 데이터를 변환하는 프로그래밍 기법입니다.

```
[Python 객체] ←→ [ORM] ←→ [데이터베이스 테이블]
```

### 1.2. ORM의 장점

| 장점 | 설명 |
|-----|------|
| **생산성 향상** | SQL을 직접 작성하지 않고 Python 코드로 DB 조작 |
| **유지보수성** | 객체 지향적 코드로 가독성과 유지보수 용이 |
| **DB 독립성** | DB 종류를 쉽게 변경 가능 (MySQL ↔ PostgreSQL) |
| **타입 안정성** | IDE의 자동완성과 타입 체크 지원 |
| **보안** | SQL 인젝션 공격 방지 |

### 1.3. ORM의 단점

| 단점 | 설명 |
|-----|------|
| **성능 오버헤드** | 복잡한 쿼리에서 순수 SQL보다 느릴 수 있음 |
| **학습 곡선** | ORM 자체를 학습해야 함 |
| **복잡한 쿼리** | 매우 복잡한 쿼리는 Raw SQL이 더 나을 수 있음 |

### 1.4. ORM 없이 SQL 사용 vs ORM 사용

#### SQL 직접 사용 (Raw SQL)
```python
import sqlite3

# 연결
conn = sqlite3.connect('database.db')
cursor = conn.cursor()

# 테이블 생성
cursor.execute('''
    CREATE TABLE users (
        id INTEGER PRIMARY KEY,
        name TEXT,
        email TEXT
    )
''')

# 데이터 삽입
cursor.execute("INSERT INTO users (name, email) VALUES (?, ?)",
               ('홍길동', 'hong@example.com'))
conn.commit()

# 데이터 조회
cursor.execute("SELECT * FROM users WHERE name = ?", ('홍길동',))
result = cursor.fetchall()
print(result)  # [(1, '홍길동', 'hong@example.com')]

conn.close()
```

#### ORM 사용 (SQLAlchemy)
```python
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

Base = declarative_base()

# 모델 정의
class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    email = Column(String)

# 연결 및 테이블 생성
engine = create_engine('sqlite:///database.db')
Base.metadata.create_all(engine)

# 세션 생성
Session = sessionmaker(bind=engine)
session = Session()

# 데이터 삽입
user = User(name='홍길동', email='hong@example.com')
session.add(user)
session.commit()

# 데이터 조회
result = session.query(User).filter(User.name == '홍길동').first()
print(result.name, result.email)  # 홍길동 hong@example.com

session.close()
```

**차이점 요약**:
- Raw SQL: 문자열로 쿼리 작성, 타입 안정성 없음
- ORM: Python 객체로 조작, IDE 자동완성 지원, 타입 안정성

---

## 2. SQLAlchemy의 개념

### 2.1. SQLAlchemy란?

**SQLAlchemy**는 Python에서 가장 널리 사용되는 SQL 툴킷이자 ORM 라이브러리입니다.

```
SQLAlchemy
├── Core (SQL Expression Language)
│   └── 저수준 SQL 생성 및 실행
└── ORM (Object Relational Mapper)
    └── 고수준 객체 지향 인터페이스
```

### 2.2. SQLAlchemy의 주요 특징

| 특징 | 설명 |
|-----|------|
| **두 가지 API** | Core API (SQL 중심) + ORM API (객체 중심) |
| **다중 DB 지원** | SQLite, PostgreSQL, MySQL, Oracle, MS SQL 등 |
| **Connection Pool** | 데이터베이스 연결 재사용으로 성능 향상 |
| **Migration 지원** | Alembic과 통합하여 스키마 변경 관리 |
| **관계 매핑** | 1:N, N:M 등 복잡한 관계 표현 가능 |

### 2.3. SQLAlchemy의 아키텍처

```
┌─────────────────────────────────────┐
│         Application Code            │
├─────────────────────────────────────┤
│         ORM (Session)               │  ← 고수준 API
├─────────────────────────────────────┤
│    SQL Expression Language          │  ← Core API
├─────────────────────────────────────┤
│         Engine                      │  ← 연결 관리
├─────────────────────────────────────┤
│      Connection Pool                │  ← 연결 풀링
├─────────────────────────────────────┤
│         DBAPI                       │  ← DB 드라이버
├─────────────────────────────────────┤
│        Database                     │
└─────────────────────────────────────┘
```

### 2.4. ORM 방식 vs Core 방식

#### ORM 방식 (권장)
```python
# 객체 지향적 접근
user = session.query(User).filter(User.name == '홍길동').first()
print(user.email)
```

**장점**: 가독성 좋음, IDE 지원, 유지보수 용이
**단점**: 복잡한 쿼리에서는 성능 저하 가능

#### Core 방식
```python
# SQL 중심 접근
from sqlalchemy import select, text

stmt = select(User).where(User.name == '홍길동')
result = session.execute(stmt).scalar_one()
```

**장점**: 성능 최적화 가능, SQL에 가까운 표현
**단점**: ORM보다 코드가 길어질 수 있음

---

## 3. 설치 방법

### 3.1. 기본 설치

```bash
# SQLAlchemy 설치
pip install sqlalchemy

# 설치 확인
pip show sqlalchemy
```

**출력 예시**:
```
Name: SQLAlchemy
Version: 2.0.23
Summary: Database Abstraction Library
Home-page: https://www.sqlalchemy.org
```

### 3.2. 데이터베이스 드라이버 설치

SQLAlchemy는 DB와 통신하기 위해 DBAPI 드라이버가 필요합니다.

#### SQLite (내장)
```bash
# Python에 기본 포함되어 있어 별도 설치 불필요
```

#### PostgreSQL
```bash
pip install psycopg2-binary
```

#### MySQL
```bash
pip install pymysql
# 또는
pip install mysqlclient
```

#### MS SQL Server
```bash
pip install pyodbc
```

### 3.3. 전체 패키지 설치 (실습용)

```bash
# SQLAlchemy + 주요 DB 드라이버
pip install sqlalchemy psycopg2-binary pymysql

# 마이그레이션 도구 (선택)
pip install alembic
```

### 3.4. 버전 확인 및 테스트

```python
# version_check.py
import sqlalchemy

print(f"SQLAlchemy 버전: {sqlalchemy.__version__}")

# 간단한 연결 테스트
from sqlalchemy import create_engine

# SQLite 메모리 DB로 테스트
engine = create_engine('sqlite:///:memory:')
with engine.connect() as conn:
    result = conn.execute(sqlalchemy.text("SELECT 1"))
    print(f"연결 테스트 결과: {result.scalar()}")
```

**실행**:
```bash
python version_check.py
```

**출력**:
```
SQLAlchemy 버전: 2.0.23
연결 테스트 결과: 1
```

---

## 4. 데이터베이스 연결

### 4.1. 연결 문자열 (Database URL)

SQLAlchemy는 표준화된 URL 형식으로 DB에 연결합니다.

#### 기본 형식
```
dialect+driver://username:password@host:port/database
```

#### 데이터베이스별 연결 문자열

| DB | 연결 문자열 예시 |
|----|----------------|
| **SQLite** | `sqlite:///database.db` (파일)<br>`sqlite:///:memory:` (메모리) |
| **PostgreSQL** | `postgresql+psycopg2://user:pass@localhost/mydb` |
| **MySQL** | `mysql+pymysql://user:pass@localhost/mydb` |
| **MS SQL** | `mssql+pyodbc://user:pass@localhost/mydb` |

### 4.2. Engine 생성

```python
from sqlalchemy import create_engine

# SQLite (파일 기반)
engine = create_engine('sqlite:///app.db')

# SQLite (메모리 - 테스트용)
engine = create_engine('sqlite:///:memory:')

# PostgreSQL
engine = create_engine('postgresql+psycopg2://user:password@localhost:5432/mydb')

# MySQL
engine = create_engine('mysql+pymysql://user:password@localhost:3306/mydb')

# 옵션 추가
engine = create_engine(
    'sqlite:///app.db',
    echo=True,  # SQL 로그 출력
    pool_size=10,  # 연결 풀 크기
    max_overflow=20  # 최대 추가 연결 수
)
```

### 4.3. 연결 옵션

| 옵션 | 설명 | 예시 |
|-----|------|------|
| `echo` | SQL 쿼리 로그 출력 | `echo=True` |
| `pool_size` | 연결 풀의 기본 크기 | `pool_size=5` |
| `max_overflow` | 풀 크기 초과 시 추가 연결 수 | `max_overflow=10` |
| `pool_pre_ping` | 연결 유효성 사전 검사 | `pool_pre_ping=True` |
| `connect_args` | DB 드라이버에 전달할 인자 | `connect_args={"timeout": 30}` |

### 4.4. 연결 테스트

```python
from sqlalchemy import create_engine, text

# Engine 생성
engine = create_engine('sqlite:///test.db', echo=True)

# 연결 테스트
try:
    with engine.connect() as connection:
        result = connection.execute(text("SELECT 1"))
        print(f"연결 성공: {result.scalar()}")
except Exception as e:
    print(f"연결 실패: {e}")
```

### 4.5. Session 생성

ORM을 사용하려면 Session이 필요합니다.

```python
from sqlalchemy.orm import sessionmaker

# Session 클래스 생성
Session = sessionmaker(bind=engine)

# Session 인스턴스 생성
session = Session()

# 작업 수행
# ...

# 세션 종료
session.close()
```

#### Context Manager 사용 (권장)

```python
from sqlalchemy.orm import Session

# with 문으로 자동 종료
with Session(engine) as session:
    # 작업 수행
    result = session.query(User).all()
    # session.close() 자동 호출
```

### 4.6. 환경별 연결 설정

#### 개발/운영 환경 분리

```python
import os
from sqlalchemy import create_engine

# 환경 변수로 DB URL 관리
DATABASE_URL = os.getenv(
    'DATABASE_URL',
    'sqlite:///dev.db'  # 기본값 (개발용)
)

engine = create_engine(DATABASE_URL)
```

#### .env 파일 사용

```bash
# .env
DATABASE_URL=postgresql+psycopg2://user:pass@localhost/prod_db
DB_ECHO=false
DB_POOL_SIZE=10
```

```python
from dotenv import load_dotenv
import os
from sqlalchemy import create_engine

# .env 로드
load_dotenv()

engine = create_engine(
    os.getenv('DATABASE_URL'),
    echo=os.getenv('DB_ECHO', 'false').lower() == 'true',
    pool_size=int(os.getenv('DB_POOL_SIZE', '5'))
)
```

---

## 5. 실습 코드

### 5.1. 기본 연결 및 테스트

```python
# 01_basic_connection.py
import sys, io
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

from sqlalchemy import create_engine, text

def test_connection():
    """데이터베이스 연결 테스트"""

    # 1. Engine 생성
    print("=== 1. Engine 생성 ===")
    engine = create_engine('sqlite:///test.db', echo=False)
    print(f"Engine 생성 완료: {engine}")

    # 2. 연결 테스트
    print("\n=== 2. 연결 테스트 ===")
    try:
        with engine.connect() as conn:
            result = conn.execute(text("SELECT 'Hello SQLAlchemy!'"))
            message = result.scalar()
            print(f"연결 성공: {message}")
    except Exception as e:
        print(f"연결 실패: {e}")

    # 3. 테이블 생성 테스트
    print("\n=== 3. 테이블 생성 테스트 ===")
    with engine.connect() as conn:
        # 테이블 생성
        conn.execute(text('''
            CREATE TABLE IF NOT EXISTS test_users (
                id INTEGER PRIMARY KEY,
                name TEXT,
                email TEXT
            )
        '''))
        conn.commit()
        print("테이블 생성 완료")

        # 데이터 삽입
        conn.execute(text(
            "INSERT INTO test_users (name, email) VALUES (:name, :email)"
        ), {"name": "홍길동", "email": "hong@test.com"})
        conn.commit()
        print("데이터 삽입 완료")

        # 데이터 조회
        result = conn.execute(text("SELECT * FROM test_users"))
        rows = result.fetchall()
        print(f"조회 결과: {rows}")

    # 4. Engine 정보 확인
    print("\n=== 4. Engine 정보 ===")
    print(f"DB URL: {engine.url}")
    print(f"Driver: {engine.driver}")
    print(f"Dialect: {engine.dialect.name}")

if __name__ == "__main__":
    test_connection()
```

### 5.2. ORM 기본 예제

```python
# 02_orm_basic.py
import sys, io
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.orm import declarative_base, Session

# Base 클래스 생성
Base = declarative_base()

# User 모델 정의
class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String(50))
    email = Column(String(100))

    def __repr__(self):
        return f"<User(id={self.id}, name='{self.name}', email='{self.email}')>"

def orm_demo():
    """ORM 기본 사용법 데모"""

    # 1. Engine 생성
    print("=== 1. Engine 생성 및 테이블 생성 ===")
    engine = create_engine('sqlite:///orm_demo.db', echo=False)
    Base.metadata.create_all(engine)
    print("테이블 생성 완료")

    # 2. 데이터 삽입
    print("\n=== 2. 데이터 삽입 (Create) ===")
    with Session(engine) as session:
        # 사용자 객체 생성
        user1 = User(name='홍길동', email='hong@example.com')
        user2 = User(name='김철수', email='kim@example.com')
        user3 = User(name='이영희', email='lee@example.com')

        # 세션에 추가
        session.add_all([user1, user2, user3])
        session.commit()
        print(f"추가됨: {user1}, {user2}, {user3}")

    # 3. 데이터 조회
    print("\n=== 3. 데이터 조회 (Read) ===")
    with Session(engine) as session:
        # 전체 조회
        users = session.query(User).all()
        print(f"전체 사용자 ({len(users)}명):")
        for user in users:
            print(f"  {user}")

        # 조건 조회
        user = session.query(User).filter(User.name == '홍길동').first()
        print(f"\n이름이 '홍길동'인 사용자: {user}")

    # 4. 데이터 수정
    print("\n=== 4. 데이터 수정 (Update) ===")
    with Session(engine) as session:
        user = session.query(User).filter(User.name == '홍길동').first()
        user.email = 'hong_new@example.com'
        session.commit()
        print(f"수정됨: {user}")

    # 5. 데이터 삭제
    print("\n=== 5. 데이터 삭제 (Delete) ===")
    with Session(engine) as session:
        user = session.query(User).filter(User.name == '이영희').first()
        session.delete(user)
        session.commit()
        print(f"삭제됨: 이영희")

        # 남은 사용자 확인
        remaining = session.query(User).count()
        print(f"남은 사용자 수: {remaining}명")

if __name__ == "__main__":
    orm_demo()
```

### 5.3. 다중 DB 연결 예제

```python
# 03_multiple_databases.py
import sys, io
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

from sqlalchemy import create_engine, text

def connect_multiple_databases():
    """여러 데이터베이스 연결 예제"""

    # 1. SQLite 파일 DB
    print("=== 1. SQLite 파일 DB ===")
    sqlite_file = create_engine('sqlite:///file_db.db')
    with sqlite_file.connect() as conn:
        result = conn.execute(text("SELECT 'SQLite File DB'"))
        print(f"연결: {result.scalar()}")

    # 2. SQLite 메모리 DB
    print("\n=== 2. SQLite 메모리 DB ===")
    sqlite_memory = create_engine('sqlite:///:memory:')
    with sqlite_memory.connect() as conn:
        result = conn.execute(text("SELECT 'SQLite Memory DB'"))
        print(f"연결: {result.scalar()}")

    # 3. PostgreSQL (예시 - 실제 서버 필요)
    print("\n=== 3. PostgreSQL (예시) ===")
    # postgresql_url = 'postgresql+psycopg2://user:pass@localhost/mydb'
    # pg_engine = create_engine(postgresql_url)
    print("연결 문자열: postgresql+psycopg2://user:pass@localhost/mydb")

    # 4. MySQL (예시 - 실제 서버 필요)
    print("\n=== 4. MySQL (예시) ===")
    # mysql_url = 'mysql+pymysql://user:pass@localhost/mydb'
    # mysql_engine = create_engine(mysql_url)
    print("연결 문자열: mysql+pymysql://user:pass@localhost/mydb")

if __name__ == "__main__":
    connect_multiple_databases()
```

### 5.4. 실행 방법

```bash
# 1. 기본 연결 테스트
python 01_basic_connection.py

# 2. ORM 기본 사용법
python 02_orm_basic.py

# 3. 다중 DB 연결
python 03_multiple_databases.py
```

### 5.5. 예상 출력

#### 01_basic_connection.py
```
=== 1. Engine 생성 ===
Engine 생성 완료: Engine(sqlite:///test.db)

=== 2. 연결 테스트 ===
연결 성공: Hello SQLAlchemy!

=== 3. 테이블 생성 테스트 ===
테이블 생성 완료
데이터 삽입 완료
조회 결과: [(1, '홍길동', 'hong@test.com')]

=== 4. Engine 정보 ===
DB URL: sqlite:///test.db
Driver: pysqlite
Dialect: sqlite
```

#### 02_orm_basic.py
```
=== 1. Engine 생성 및 테이블 생성 ===
테이블 생성 완료

=== 2. 데이터 삽입 (Create) ===
추가됨: <User(id=1, name='홍길동', email='hong@example.com')>, ...

=== 3. 데이터 조회 (Read) ===
전체 사용자 (3명):
  <User(id=1, name='홍길동', email='hong@example.com')>
  <User(id=2, name='김철수', email='kim@example.com')>
  <User(id=3, name='이영희', email='lee@example.com')>

이름이 '홍길동'인 사용자: <User(id=1, name='홍길동', email='hong@example.com')>

=== 4. 데이터 수정 (Update) ===
수정됨: <User(id=1, name='홍길동', email='hong_new@example.com')>

=== 5. 데이터 삭제 (Delete) ===
삭제됨: 이영희
남은 사용자 수: 2명
```

---

## 다음 단계

SQLAlchemy의 기본 개념과 연결 방법을 이해했다면, 다음 단계에서는 **SQLAlchemy 모델**을 만들고 관계를 설정하는 방법을 배워보겠습니다.

**다음 문서**: [1.3.02. SQLAlchemy 모델 만들기](./1.3.02.SQLAlchemy%20모델%20만들기.md)

### 다음에 배울 내용
- Model의 개념과 구성 요소
- 테이블 생성과 조작
- 관계 설정 (1:N, N:M)
- 실전 모델 예시

---

**참고 자료**:
- SQLAlchemy 공식 문서: https://docs.sqlalchemy.org/
- SQLAlchemy ORM Tutorial: https://docs.sqlalchemy.org/en/20/tutorial/
- SQLAlchemy 2.0 마이그레이션 가이드: https://docs.sqlalchemy.org/en/20/changelog/migration_20.html
