# 1.2.10. Elasticsearch 기본 활용법

> **작성자**: Bern
> **작성일**: 2025-10-25
> **카테고리**: Elasticsearch / Python

---

## 목차
1. [Python에서 Elasticsearch 연결](#1-python에서-elasticsearch-연결)
2. [CRUD 작업](#2-crud-작업)
3. [검색 쿼리](#3-검색-쿼리)
4. [집계(Aggregation)](#4-집계aggregation)
5. [실전 예시 코드](#5-실전-예시-코드)
6. [다음 단계](#6-다음-단계)

---

## 1. Python에서 Elasticsearch 연결

### 1.1. 라이브러리 설치

```bash
# Elasticsearch Python 클라이언트 설치
pip install elasticsearch

# 추가 유틸리티 (선택사항)
pip install elasticsearch-dsl
```

### 1.2. 기본 연결

```python
from elasticsearch import Elasticsearch

# Elasticsearch 연결
es = Elasticsearch(
    ['http://localhost:9200'],
    # 인증이 필요한 경우
    # basic_auth=('username', 'password')
)

# 연결 확인
if es.ping():
    print("Elasticsearch 연결 성공")
else:
    print("Elasticsearch 연결 실패")

# 클러스터 정보 확인
info = es.info()
print(f"클러스터 이름: {info['cluster_name']}")
print(f"버전: {info['version']['number']}")
```

### 1.3. 인덱스 관리

```python
# 인덱스 생성
index_name = 'my_index'

# 매핑과 함께 인덱스 생성
mapping = {
    "mappings": {
        "properties": {
            "title": {"type": "text"},
            "content": {"type": "text"},
            "category": {"type": "keyword"},
            "created_at": {"type": "date"}
        }
    }
}

if not es.indices.exists(index=index_name):
    es.indices.create(index=index_name, body=mapping)
    print(f"인덱스 '{index_name}' 생성")

# 인덱스 목록 조회
indices = es.indices.get_alias(index="*")
print(f"인덱스 목록: {list(indices.keys())}")

# 인덱스 삭제
# es.indices.delete(index=index_name)
```

---

## 2. CRUD 작업

### 2.1. Create (생성)

```python
# 단일 문서 저장
doc = {
    "title": "스마트팜 기술 개요",
    "content": "ICT 기술을 활용한 지능형 농업 시스템입니다.",
    "category": "기술",
    "created_at": "2024-10-25"
}

# 문서 ID 지정
response = es.index(
    index=index_name,
    id='doc_001',  # ID 지정 (선택)
    document=doc
)

print(f"문서 저장: {response['result']}")  # created 또는 updated

# 문서 ID 자동 생성
response = es.index(
    index=index_name,
    document=doc  # ID 미지정 시 자동 생성
)

print(f"자동 생성된 ID: {response['_id']}")
```

### 2.2. Read (조회)

```python
# 문서 ID로 조회
doc_id = 'doc_001'
result = es.get(index=index_name, id=doc_id)

print(f"문서 조회:")
print(f"  ID: {result['_id']}")
print(f"  내용: {result['_source']}")

# 문서 존재 여부 확인
exists = es.exists(index=index_name, id=doc_id)
print(f"문서 존재: {exists}")

# 전체 문서 조회 (match_all)
search_result = es.search(
    index=index_name,
    body={
        "query": {"match_all": {}},
        "size": 10  # 조회 개수
    }
)

print(f"\n전체 문서 수: {search_result['hits']['total']['value']}")
for hit in search_result['hits']['hits']:
    print(f"  - {hit['_source']['title']}")
```

### 2.3. Update (수정)

```python
# 부분 업데이트 (특정 필드만)
es.update(
    index=index_name,
    id='doc_001',
    body={
        "doc": {
            "category": "기술/개요"  # category 필드만 수정
        }
    }
)

print("문서 부분 업데이트 완료")

# 스크립트로 업데이트
es.update(
    index=index_name,
    id='doc_001',
    body={
        "script": {
            "source": "ctx._source.view_count = params.count",
            "params": {"count": 100}
        }
    }
)

# 전체 문서 교체
new_doc = {
    "title": "스마트팜 기술 개요 (수정)",
    "content": "업데이트된 내용입니다.",
    "category": "기술",
    "created_at": "2024-10-25"
}

es.index(
    index=index_name,
    id='doc_001',
    document=new_doc  # 전체 교체
)
```

### 2.4. Delete (삭제)

```python
# 단일 문서 삭제
es.delete(index=index_name, id='doc_001')
print("문서 삭제 완료")

# 쿼리로 문서 삭제 (조건에 맞는 문서 모두 삭제)
es.delete_by_query(
    index=index_name,
    body={
        "query": {
            "match": {
                "category": "임시"
            }
        }
    }
)

print("카테고리가 '임시'인 문서 모두 삭제")
```

### 2.5. Bulk 작업 (대량 처리)

```python
from elasticsearch.helpers import bulk

# 여러 문서 한 번에 저장
documents = [
    {
        "title": f"문서 {i}",
        "content": f"내용 {i}",
        "category": "테스트",
        "created_at": "2024-10-25"
    }
    for i in range(100)
]

# Bulk 저장용 제너레이터
def generate_actions():
    for i, doc in enumerate(documents):
        yield {
            "_index": index_name,
            "_id": f"bulk_{i}",
            "_source": doc
        }

# Bulk 실행
success, failed = bulk(es, generate_actions())
print(f"Bulk 저장: 성공 {success}개, 실패 {len(failed)}개")

# 인덱스 새로고침 (즉시 검색 가능하도록)
es.indices.refresh(index=index_name)
```

---

## 3. 검색 쿼리

### 3.1. Match 쿼리 (전문 검색)

```python
# 기본 match 쿼리
search_result = es.search(
    index=index_name,
    body={
        "query": {
            "match": {
                "content": "스마트팜"
            }
        }
    }
)

print(f"검색 결과: {search_result['hits']['total']['value']}개")
for hit in search_result['hits']['hits']:
    print(f"  - {hit['_source']['title']} (점수: {hit['_score']:.2f})")

# Multi-match (여러 필드 검색)
search_result = es.search(
    index=index_name,
    body={
        "query": {
            "multi_match": {
                "query": "스마트팜",
                "fields": ["title", "content"]
            }
        }
    }
)
```

### 3.2. Term 쿼리 (정확한 매칭)

```python
# Keyword 필드 정확히 매칭
search_result = es.search(
    index=index_name,
    body={
        "query": {
            "term": {
                "category.keyword": "기술"  # .keyword 주의
            }
        }
    }
)

# Terms 쿼리 (여러 값 중 하나)
search_result = es.search(
    index=index_name,
    body={
        "query": {
            "terms": {
                "category.keyword": ["기술", "사례", "연구"]
            }
        }
    }
)
```

### 3.3. Bool 쿼리 (복합 조건)

```python
# Bool 쿼리: must (AND), should (OR), must_not (NOT)
search_result = es.search(
    index=index_name,
    body={
        "query": {
            "bool": {
                "must": [  # 반드시 포함 (AND)
                    {"match": {"content": "스마트팜"}}
                ],
                "should": [  # 하나라도 포함 (OR)
                    {"match": {"content": "센서"}},
                    {"match": {"content": "AI"}}
                ],
                "must_not": [  # 제외 (NOT)
                    {"match": {"content": "테스트"}}
                ],
                "filter": [  # 필터 (점수 영향 없음)
                    {"term": {"category.keyword": "기술"}}
                ]
            }
        }
    }
)

print(f"복합 검색 결과: {search_result['hits']['total']['value']}개")
```

### 3.4. Range 쿼리 (범위 검색)

```python
# 날짜 범위 검색
search_result = es.search(
    index=index_name,
    body={
        "query": {
            "range": {
                "created_at": {
                    "gte": "2024-10-01",  # 이상
                    "lte": "2024-10-31"   # 이하
                }
            }
        }
    }
)

# 숫자 범위 검색
search_result = es.search(
    index=index_name,
    body={
        "query": {
            "range": {
                "view_count": {
                    "gte": 100,
                    "lt": 1000
                }
            }
        }
    }
)
```

### 3.5. 페이지네이션

```python
# from, size로 페이징
page = 2
page_size = 10

search_result = es.search(
    index=index_name,
    body={
        "query": {"match_all": {}},
        "from": (page - 1) * page_size,  # 시작 위치
        "size": page_size                # 개수
    }
)

print(f"페이지 {page}: {len(search_result['hits']['hits'])}개")
```

### 3.6. 정렬

```python
# 단일 필드 정렬
search_result = es.search(
    index=index_name,
    body={
        "query": {"match_all": {}},
        "sort": [
            {"created_at": {"order": "desc"}}  # 내림차순
        ]
    }
)

# 다중 필드 정렬
search_result = es.search(
    index=index_name,
    body={
        "query": {"match_all": {}},
        "sort": [
            {"category.keyword": {"order": "asc"}},   # 1순위
            {"created_at": {"order": "desc"}}         # 2순위
        ]
    }
)
```

---

## 4. 집계(Aggregation)

### 4.1. 기본 집계

```python
# 카테고리별 문서 수 (Terms Aggregation)
agg_result = es.search(
    index=index_name,
    body={
        "size": 0,  # 문서는 반환하지 않음 (집계 결과만)
        "aggs": {
            "categories": {  # 집계 이름
                "terms": {
                    "field": "category.keyword",
                    "size": 10  # 상위 10개
                }
            }
        }
    }
)

print("카테고리별 문서 수:")
for bucket in agg_result['aggregations']['categories']['buckets']:
    print(f"  - {bucket['key']}: {bucket['doc_count']}개")
```

### 4.2. 통계 집계

```python
# 숫자 필드 통계 (Stats Aggregation)
agg_result = es.search(
    index=index_name,
    body={
        "size": 0,
        "aggs": {
            "view_stats": {
                "stats": {
                    "field": "view_count"
                }
            }
        }
    }
)

stats = agg_result['aggregations']['view_stats']
print(f"조회수 통계:")
print(f"  평균: {stats['avg']:.2f}")
print(f"  최소: {stats['min']}")
print(f"  최대: {stats['max']}")
print(f"  합계: {stats['sum']}")
print(f"  개수: {stats['count']}")
```

### 4.3. 날짜 히스토그램

```python
# 월별 문서 수
agg_result = es.search(
    index=index_name,
    body={
        "size": 0,
        "aggs": {
            "monthly_docs": {
                "date_histogram": {
                    "field": "created_at",
                    "calendar_interval": "month"  # 월 단위
                }
            }
        }
    }
)

print("월별 문서 수:")
for bucket in agg_result['aggregations']['monthly_docs']['buckets']:
    print(f"  - {bucket['key_as_string']}: {bucket['doc_count']}개")
```

---

## 5. 실전 예시 코드

### 5.1. Elasticsearch 헬퍼 클래스

```python
from typing import List, Dict, Optional

class ElasticsearchHelper:
    """Elasticsearch 작업 헬퍼 클래스"""

    def __init__(self, es_client, index_name):
        """
        Args:
            es_client: Elasticsearch 클라이언트
            index_name: 기본 인덱스 이름
        """
        self.es = es_client
        self.index_name = index_name

    def save_document(self, doc: Dict, doc_id: Optional[str] = None):
        """문서 저장"""
        return self.es.index(
            index=self.index_name,
            id=doc_id,
            document=doc
        )

    def get_document(self, doc_id: str) -> Optional[Dict]:
        """문서 조회"""
        try:
            result = self.es.get(index=self.index_name, id=doc_id)
            return result['_source']
        except:
            return None

    def search_documents(self, query: str, fields: List[str] = None,
                         size: int = 10) -> List[Dict]:
        """문서 검색"""
        if fields is None:
            fields = ["title", "content"]

        search_body = {
            "query": {
                "multi_match": {
                    "query": query,
                    "fields": fields
                }
            },
            "size": size
        }

        result = self.es.search(index=self.index_name, body=search_body)

        return [
            {
                "id": hit['_id'],
                "score": hit['_score'],
                **hit['_source']
            }
            for hit in result['hits']['hits']
        ]

    def count_by_category(self) -> Dict[str, int]:
        """카테고리별 문서 수"""
        agg_result = self.es.search(
            index=self.index_name,
            body={
                "size": 0,
                "aggs": {
                    "categories": {
                        "terms": {
                            "field": "category.keyword"
                        }
                    }
                }
            }
        )

        return {
            bucket['key']: bucket['doc_count']
            for bucket in agg_result['aggregations']['categories']['buckets']
        }

    def delete_old_documents(self, days: int):
        """오래된 문서 삭제"""
        from datetime import datetime, timedelta

        cutoff_date = (datetime.now() - timedelta(days=days)).strftime('%Y-%m-%d')

        self.es.delete_by_query(
            index=self.index_name,
            body={
                "query": {
                    "range": {
                        "created_at": {
                            "lt": cutoff_date
                        }
                    }
                }
            }
        )


# 사용 예시
helper = ElasticsearchHelper(es, 'my_index')

# 문서 저장
helper.save_document({
    "title": "테스트",
    "content": "내용",
    "category": "테스트",
    "created_at": "2024-10-25"
}, doc_id="test_001")

# 검색
results = helper.search_documents("스마트팜", fields=["title", "content"])
for r in results:
    print(f"{r['title']} (점수: {r['score']:.2f})")

# 카테고리별 통계
stats = helper.count_by_category()
print(f"카테고리 통계: {stats}")
```

---

## 6. 다음 단계

Elasticsearch 기본 활용법을 익혔다면, 다음은 **LLM 호출**입니다.

**다음 문서**: [1.2.11. Agent, RAG 개발 - LLM 호출](./1.2.11.Agent,%20RAG%20개발%20-LLM%20호출.md)

### 다음에 배울 내용
- OpenAI API 호출
- HuggingFace Transformers 모델 사용
- Config 파일 관리
- 실습 코드 및 결과

---

**참고 자료**:
- Elasticsearch Python Client: https://elasticsearch-py.readthedocs.io/
- Elasticsearch Query DSL: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html
