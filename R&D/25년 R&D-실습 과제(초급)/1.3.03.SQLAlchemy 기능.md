# 1.3.03. SQLAlchemy 기능

> **작성자**: Bern
> **작성일**: 2025-10-26
> **카테고리**: 데이터베이스

---

## 목차
1. [SELECT (조회)](#1-select-조회)
2. [INSERT (삽입)](#2-insert-삽입)
3. [UPDATE (수정)](#3-update-수정)
4. [DELETE (삭제)](#4-delete-삭제)
5. [ORM 방식과 Core 방식의 차이와 장단점](#5-orm-방식과-core-방식의-차이와-장단점)
6. [실습 코드](#6-실습-코드)

---

## 1. SELECT (조회)

### 1.1. ORM 방식 - 기본 조회

```python
from sqlalchemy.orm import Session

# 전체 조회
users = session.query(User).all()

# 단일 조회
user = session.query(User).first()

# 조건 조회
user = session.query(User).filter(User.id == 1).first()

# 여러 조건
users = session.query(User).filter(
    User.is_active == True,
    User.age >= 18
).all()
```

### 1.2. ORM 방식 - 고급 조회

#### WHERE 조건

```python
# 단일 조건
users = session.query(User).filter(User.name == '홍길동').all()

# 여러 조건 (AND)
users = session.query(User).filter(
    User.age >= 20,
    User.is_active == True
).all()

# OR 조건
from sqlalchemy import or_
users = session.query(User).filter(
    or_(User.name == '홍길동', User.name == '김철수')
).all()

# IN 조건
users = session.query(User).filter(User.name.in_(['홍길동', '김철수'])).all()

# LIKE 조건
users = session.query(User).filter(User.name.like('%길동%')).all()

# 비교 연산자
users = session.query(User).filter(User.age > 20).all()
users = session.query(User).filter(User.age.between(20, 30)).all()

# NULL 체크
users = session.query(User).filter(User.phone == None).all()
users = session.query(User).filter(User.phone.is_(None)).all()
users = session.query(User).filter(User.phone.isnot(None)).all()
```

#### 정렬 (ORDER BY)

```python
# 오름차순
users = session.query(User).order_by(User.name).all()

# 내림차순
from sqlalchemy import desc
users = session.query(User).order_by(desc(User.created_at)).all()

# 여러 컬럼 정렬
users = session.query(User).order_by(User.age, desc(User.name)).all()
```

#### 제한 (LIMIT, OFFSET)

```python
# 상위 10개
users = session.query(User).limit(10).all()

# 5개 건너뛰고 10개
users = session.query(User).offset(5).limit(10).all()

# 페이지네이션 (2페이지, 페이지당 10개)
page = 2
per_page = 10
users = session.query(User).offset((page - 1) * per_page).limit(per_page).all()
```

#### 집계 함수

```python
from sqlalchemy import func

# 개수
count = session.query(func.count(User.id)).scalar()

# 평균
avg_age = session.query(func.avg(User.age)).scalar()

# 최대/최소
max_age = session.query(func.max(User.age)).scalar()
min_age = session.query(func.min(User.age)).scalar()

# 합계
total = session.query(func.sum(Product.price)).scalar()

# GROUP BY
results = session.query(
    User.city,
    func.count(User.id).label('count')
).group_by(User.city).all()

for city, count in results:
    print(f"{city}: {count}명")
```

#### 조인 (JOIN)

```python
# INNER JOIN
results = session.query(User, Post).join(Post).all()

# LEFT JOIN
results = session.query(User).outerjoin(Post).all()

# 특정 컬럼만 조회
results = session.query(User.name, Post.title).join(Post).all()

# 조인 조건 명시
results = session.query(User).join(Post, User.id == Post.user_id).all()
```

### 1.3. Core 방식 - SELECT

```python
from sqlalchemy import select

# 기본 조회
stmt = select(User)
result = session.execute(stmt)
users = result.scalars().all()

# 조건 조회
stmt = select(User).where(User.name == '홍길동')
result = session.execute(stmt)
user = result.scalar_one()

# 여러 조건
stmt = select(User).where(User.age >= 20, User.is_active == True)
users = session.execute(stmt).scalars().all()

# 정렬
stmt = select(User).order_by(User.name)
users = session.execute(stmt).scalars().all()

# 제한
stmt = select(User).limit(10)
users = session.execute(stmt).scalars().all()
```

---

## 2. INSERT (삽입)

### 2.1. ORM 방식 - 단일 삽입

```python
# 객체 생성
user = User(name='홍길동', email='hong@test.com', age=25)

# 세션에 추가
session.add(user)

# 데이터베이스에 저장
session.commit()

# 자동 생성된 ID 확인
print(f"새로운 사용자 ID: {user.id}")
```

### 2.2. ORM 방식 - 다중 삽입

```python
# 여러 객체 생성
users = [
    User(name='홍길동', email='hong@test.com'),
    User(name='김철수', email='kim@test.com'),
    User(name='이영희', email='lee@test.com')
]

# 한 번에 추가
session.add_all(users)
session.commit()

print(f"{len(users)}명의 사용자 추가됨")
```

### 2.3. ORM 방식 - 관계가 있는 데이터 삽입

```python
# 작성자와 게시글 동시 생성
author = Author(name='홍길동')
post1 = Post(title='첫 번째 글', content='내용...', author=author)
post2 = Post(title='두 번째 글', content='내용...', author=author)

# author만 추가해도 cascade로 post도 저장됨
session.add(author)
session.commit()
```

### 2.4. Core 방식 - INSERT

```python
from sqlalchemy import insert

# 단일 삽입
stmt = insert(User).values(name='홍길동', email='hong@test.com')
session.execute(stmt)
session.commit()

# 다중 삽입
stmt = insert(User).values([
    {'name': '홍길동', 'email': 'hong@test.com'},
    {'name': '김철수', 'email': 'kim@test.com'}
])
session.execute(stmt)
session.commit()
```

---

## 3. UPDATE (수정)

### 3.1. ORM 방식 - 객체 수정

```python
# 1. 조회
user = session.query(User).filter(User.id == 1).first()

# 2. 수정
user.email = 'new_email@test.com'
user.age = 30

# 3. 저장
session.commit()
```

### 3.2. ORM 방식 - 대량 수정

```python
# 조건에 맞는 모든 레코드 수정
session.query(User).filter(User.age < 20).update({
    'is_active': False
})
session.commit()

# 나이 1씩 증가
session.query(User).filter(User.city == '서울').update({
    User.age: User.age + 1
})
session.commit()
```

### 3.3. Core 방식 - UPDATE

```python
from sqlalchemy import update

# 단일 수정
stmt = update(User).where(User.id == 1).values(email='new@test.com')
session.execute(stmt)
session.commit()

# 조건부 수정
stmt = update(User).where(User.age < 20).values(is_active=False)
session.execute(stmt)
session.commit()

# 값 증가
stmt = update(User).where(User.city == '서울').values(age=User.age + 1)
session.execute(stmt)
session.commit()
```

---

## 4. DELETE (삭제)

### 4.1. ORM 방식 - 객체 삭제

```python
# 1. 조회
user = session.query(User).filter(User.id == 1).first()

# 2. 삭제
session.delete(user)

# 3. 저장
session.commit()
```

### 4.2. ORM 방식 - 대량 삭제

```python
# 조건에 맞는 모든 레코드 삭제
deleted_count = session.query(User).filter(User.is_active == False).delete()
session.commit()

print(f"{deleted_count}개의 레코드 삭제됨")
```

### 4.3. Core 방식 - DELETE

```python
from sqlalchemy import delete

# 단일 삭제
stmt = delete(User).where(User.id == 1)
session.execute(stmt)
session.commit()

# 조건부 삭제
stmt = delete(User).where(User.is_active == False)
result = session.execute(stmt)
session.commit()

print(f"{result.rowcount}개의 레코드 삭제됨")
```

### 4.4. Cascade 삭제

```python
# 관계 설정 시 cascade 옵션
class Author(Base):
    __tablename__ = 'authors'
    id = Column(Integer, primary_key=True)

    # 작성자 삭제 시 게시글도 함께 삭제
    posts = relationship('Post', cascade='all, delete-orphan')

# 사용
author = session.query(Author).filter(Author.id == 1).first()
session.delete(author)  # author의 모든 posts도 삭제됨
session.commit()
```

---

## 5. ORM 방식과 Core 방식의 차이와 장단점

### 5.1. ORM 방식

#### 특징
```python
# 객체 지향적 접근
user = session.query(User).filter(User.name == '홍길동').first()
print(user.email)

# 관계 탐색
for post in user.posts:
    print(post.title)
```

#### 장점

| 장점 | 설명 |
|-----|------|
| **직관적인 코드** | Python 객체로 조작, SQL 몰라도 사용 가능 |
| **IDE 지원** | 자동완성, 타입 체크 |
| **관계 탐색** | `user.posts`처럼 관계를 쉽게 탐색 |
| **코드 재사용** | 모델 정의를 여러 곳에서 재사용 |
| **유지보수** | 코드 가독성 높고 리팩토링 쉬움 |

#### 단점

| 단점 | 설명 |
|-----|------|
| **성능 오버헤드** | 객체 변환 비용 발생 |
| **복잡한 쿼리** | 매우 복잡한 쿼리는 표현하기 어려움 |
| **N+1 문제** | 관계 탐색 시 쿼리 폭증 가능 |
| **학습 곡선** | ORM 자체를 배워야 함 |

#### 적합한 경우
- 일반적인 CRUD 작업
- 관계가 많은 복잡한 도메인 모델
- 코드 가독성과 유지보수가 중요한 경우
- 빠른 개발이 필요한 경우

### 5.2. Core 방식

#### 특징
```python
# SQL 중심 접근
from sqlalchemy import select

stmt = select(User).where(User.name == '홍길동')
result = session.execute(stmt)
user = result.scalar_one()
```

#### 장점

| 장점 | 설명 |
|-----|------|
| **성능** | ORM보다 빠른 실행 속도 |
| **유연성** | 복잡한 쿼리를 정밀하게 작성 가능 |
| **SQL 제어** | SQL에 가까운 표현으로 세밀한 제어 |
| **대량 처리** | 대량의 데이터 처리에 효율적 |

#### 단점

| 단점 | 설명 |
|-----|------|
| **코드 복잡도** | ORM보다 코드가 길고 복잡 |
| **타입 안정성** | IDE 지원 제한적 |
| **반복 코드** | 같은 쿼리 패턴 반복 작성 |
| **관계 탐색** | 관계를 직접 JOIN으로 작성해야 함 |

#### 적합한 경우
- 성능이 매우 중요한 경우
- 복잡한 집계, 분석 쿼리
- 대량의 데이터 일괄 처리
- Raw SQL에 가까운 제어가 필요한 경우

### 5.3. 비교표

| 항목 | ORM 방식 | Core 방식 |
|-----|---------|----------|
| **코드 스타일** | 객체 지향 | SQL 중심 |
| **학습 난이도** | 중간 | 낮음 (SQL 알면 쉬움) |
| **성능** | 보통 | 빠름 |
| **가독성** | 높음 | 중간 |
| **복잡한 쿼리** | 어려움 | 쉬움 |
| **IDE 지원** | 우수 | 제한적 |
| **관계 탐색** | 쉬움 | 직접 JOIN |
| **타입 안정성** | 우수 | 보통 |

### 5.4. 혼합 사용 (권장)

실무에서는 두 방식을 상황에 맞게 혼합 사용합니다.

```python
# 일반 CRUD → ORM 사용
user = session.query(User).filter(User.id == 1).first()
user.email = 'new@test.com'
session.commit()

# 복잡한 집계 → Core 사용
from sqlalchemy import select, func

stmt = select(
    User.city,
    func.count(User.id).label('user_count'),
    func.avg(User.age).label('avg_age')
).group_by(User.city).having(func.count(User.id) > 100)

results = session.execute(stmt).all()

# 대량 수정 → Core 사용
from sqlalchemy import update

stmt = update(User).where(User.last_login < '2024-01-01').values(is_active=False)
session.execute(stmt)
session.commit()
```

### 5.5. 예제 비교

#### 같은 작업을 ORM vs Core로 구현

```python
# ===== SELECT =====

# ORM
users = session.query(User).filter(User.age >= 20).order_by(User.name).limit(10).all()

# Core
stmt = select(User).where(User.age >= 20).order_by(User.name).limit(10)
users = session.execute(stmt).scalars().all()


# ===== INSERT =====

# ORM
user = User(name='홍길동', email='hong@test.com')
session.add(user)
session.commit()

# Core
stmt = insert(User).values(name='홍길동', email='hong@test.com')
session.execute(stmt)
session.commit()


# ===== UPDATE =====

# ORM
user = session.query(User).filter(User.id == 1).first()
user.email = 'new@test.com'
session.commit()

# Core
stmt = update(User).where(User.id == 1).values(email='new@test.com')
session.execute(stmt)
session.commit()


# ===== DELETE =====

# ORM
user = session.query(User).filter(User.id == 1).first()
session.delete(user)
session.commit()

# Core
stmt = delete(User).where(User.id == 1)
session.execute(stmt)
session.commit()
```

---

## 6. 실습 코드

### 6.1. SELECT 종합 예제

```python
# 01_select_operations.py
import sys, io
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

from sqlalchemy import create_engine, Column, Integer, String, Boolean, desc, func, or_
from sqlalchemy.orm import declarative_base, Session

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String(50))
    email = Column(String(100))
    age = Column(Integer)
    city = Column(String(50))
    is_active = Column(Boolean, default=True)

def test_select():
    engine = create_engine('sqlite:///select_test.db', echo=False)
    Base.metadata.create_all(engine)

    with Session(engine) as session:
        # 테스트 데이터 생성
        users = [
            User(name='홍길동', email='hong@test.com', age=25, city='서울'),
            User(name='김철수', email='kim@test.com', age=30, city='부산'),
            User(name='이영희', email='lee@test.com', age=22, city='서울'),
            User(name='박민수', email='park@test.com', age=28, city='대구', is_active=False),
            User(name='최지연', email='choi@test.com', age=35, city='서울')
        ]
        session.add_all(users)
        session.commit()

        print("=== 1. 전체 조회 ===")
        all_users = session.query(User).all()
        print(f"총 {len(all_users)}명")

        print("\n=== 2. 조건 조회 (나이 >= 25) ===")
        users = session.query(User).filter(User.age >= 25).all()
        for user in users:
            print(f"  {user.name} ({user.age}세)")

        print("\n=== 3. 여러 조건 (서울 + 활성) ===")
        users = session.query(User).filter(
            User.city == '서울',
            User.is_active == True
        ).all()
        for user in users:
            print(f"  {user.name} - {user.city}")

        print("\n=== 4. OR 조건 ===")
        users = session.query(User).filter(
            or_(User.city == '서울', User.city == '부산')
        ).all()
        for user in users:
            print(f"  {user.name} - {user.city}")

        print("\n=== 5. LIKE 검색 ===")
        users = session.query(User).filter(User.name.like('%김%')).all()
        for user in users:
            print(f"  {user.name}")

        print("\n=== 6. 정렬 (나이 내림차순) ===")
        users = session.query(User).order_by(desc(User.age)).all()
        for user in users:
            print(f"  {user.name} ({user.age}세)")

        print("\n=== 7. LIMIT (상위 3명) ===")
        users = session.query(User).limit(3).all()
        for user in users:
            print(f"  {user.name}")

        print("\n=== 8. 집계 (도시별 사용자 수) ===")
        results = session.query(
            User.city,
            func.count(User.id).label('count')
        ).group_by(User.city).all()
        for city, count in results:
            print(f"  {city}: {count}명")

        print("\n=== 9. 평균 나이 ===")
        avg_age = session.query(func.avg(User.age)).scalar()
        print(f"  평균 나이: {avg_age:.1f}세")

if __name__ == "__main__":
    test_select()
```

### 6.2. INSERT/UPDATE/DELETE 예제

```python
# 02_crud_operations.py
import sys, io
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.orm import declarative_base, Session

Base = declarative_base()

class Product(Base):
    __tablename__ = 'products'
    id = Column(Integer, primary_key=True)
    name = Column(String(100))
    price = Column(Integer)
    stock = Column(Integer, default=0)

def test_crud():
    engine = create_engine('sqlite:///crud_test.db', echo=False)
    Base.metadata.create_all(engine)

    with Session(engine) as session:
        # ===== INSERT =====
        print("=== INSERT (단일) ===")
        product = Product(name='노트북', price=1000000, stock=10)
        session.add(product)
        session.commit()
        print(f"추가됨: {product.name} (ID: {product.id})")

        print("\n=== INSERT (다중) ===")
        products = [
            Product(name='마우스', price=30000, stock=50),
            Product(name='키보드', price=80000, stock=30),
            Product(name='모니터', price=300000, stock=15)
        ]
        session.add_all(products)
        session.commit()
        print(f"{len(products)}개 제품 추가됨")

        # ===== SELECT =====
        print("\n=== SELECT (전체 조회) ===")
        all_products = session.query(Product).all()
        for p in all_products:
            print(f"  {p.name}: {p.price:,}원 (재고: {p.stock})")

        # ===== UPDATE (객체 수정) =====
        print("\n=== UPDATE (객체 수정) ===")
        product = session.query(Product).filter(Product.name == '노트북').first()
        old_price = product.price
        product.price = 900000
        session.commit()
        print(f"{product.name} 가격: {old_price:,}원 → {product.price:,}원")

        # ===== UPDATE (대량 수정) =====
        print("\n=== UPDATE (재고 10% 증가) ===")
        session.query(Product).update({
            Product.stock: Product.stock + (Product.stock * 0.1)
        })
        session.commit()
        print("모든 제품 재고 10% 증가")

        # ===== DELETE =====
        print("\n=== DELETE (단일 삭제) ===")
        product = session.query(Product).filter(Product.name == '마우스').first()
        session.delete(product)
        session.commit()
        print(f"{product.name} 삭제됨")

        # ===== 최종 확인 =====
        print("\n=== 최종 제품 목록 ===")
        remaining = session.query(Product).all()
        for p in remaining:
            print(f"  {p.name}: {p.price:,}원 (재고: {p.stock})")

if __name__ == "__main__":
    test_crud()
```

### 6.3. ORM vs Core 비교 예제

```python
# 03_orm_vs_core.py
import sys, io
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

from sqlalchemy import create_engine, Column, Integer, String, select, insert, update, delete
from sqlalchemy.orm import declarative_base, Session

Base = declarative_base()

class Book(Base):
    __tablename__ = 'books'
    id = Column(Integer, primary_key=True)
    title = Column(String(200))
    author = Column(String(100))
    price = Column(Integer)

def test_orm_vs_core():
    engine = create_engine('sqlite:///books.db', echo=False)
    Base.metadata.create_all(engine)

    with Session(engine) as session:
        # ===== INSERT 비교 =====
        print("=== INSERT 비교 ===")

        print("\n[ORM 방식]")
        book_orm = Book(title='Python 기초', author='홍길동', price=25000)
        session.add(book_orm)
        session.commit()
        print(f"추가: {book_orm.title} (ID: {book_orm.id})")

        print("\n[Core 방식]")
        stmt = insert(Book).values(title='FastAPI 가이드', author='김철수', price=30000)
        result = session.execute(stmt)
        session.commit()
        print(f"추가: FastAPI 가이드 (ID: {result.lastrowid})")

        # ===== SELECT 비교 =====
        print("\n\n=== SELECT 비교 ===")

        print("\n[ORM 방식]")
        books = session.query(Book).filter(Book.price >= 25000).all()
        for book in books:
            print(f"  {book.title} - {book.author}")

        print("\n[Core 방식]")
        stmt = select(Book).where(Book.price >= 25000)
        books = session.execute(stmt).scalars().all()
        for book in books:
            print(f"  {book.title} - {book.author}")

        # ===== UPDATE 비교 =====
        print("\n\n=== UPDATE 비교 ===")

        print("\n[ORM 방식]")
        book = session.query(Book).filter(Book.title == 'Python 기초').first()
        book.price = 22000
        session.commit()
        print(f"{book.title} 가격 변경: 22,000원")

        print("\n[Core 방식]")
        stmt = update(Book).where(Book.title == 'FastAPI 가이드').values(price=27000)
        session.execute(stmt)
        session.commit()
        print("FastAPI 가이드 가격 변경: 27,000원")

        # ===== DELETE 비교 =====
        print("\n\n=== DELETE 비교 ===")

        # 테스트용 데이터 추가
        test_book = Book(title='삭제될 책', author='테스트', price=1000)
        session.add(test_book)
        session.commit()

        print("\n[ORM 방식]")
        book = session.query(Book).filter(Book.title == '삭제될 책').first()
        session.delete(book)
        session.commit()
        print("ORM으로 삭제 완료")

        # 최종 확인
        print("\n=== 최종 도서 목록 ===")
        books = session.query(Book).all()
        for book in books:
            print(f"  {book.title} - {book.author} ({book.price:,}원)")

if __name__ == "__main__":
    test_orm_vs_core()
```

### 6.4. 실행 방법

```bash
# 1. SELECT 종합
python 01_select_operations.py

# 2. CRUD 작업
python 02_crud_operations.py

# 3. ORM vs Core 비교
python 03_orm_vs_core.py
```

---

## 다음 단계

SQLAlchemy의 핵심 기능(SELECT, INSERT, UPDATE, DELETE)과 ORM/Core 방식의 차이를 이해했다면, 다음 단계에서는 **FastAPI에서 API를 만드는 방법**을 배워보겠습니다.

**다음 문서**: [1.3.04. FastAPI API 만들기](./1.3.04.FastAPI%20API%20만들기.md)

### 다음에 배울 내용
- GET / POST / PUT / DELETE 메서드
- HTTP 데이터 전송 (Body, Query, File, Form)
- API Return 정보 작성
- 실무 예시 코드

---

**참고 자료**:
- SQLAlchemy Querying Guide: https://docs.sqlalchemy.org/en/20/orm/queryguide/
- SQLAlchemy Core: https://docs.sqlalchemy.org/en/20/core/
- ORM vs Core: https://docs.sqlalchemy.org/en/20/faq/performance.html
