# 1.1.05. Elasticsearch & Kibana 환경 구성

> **학습 목표**: Docker를 활용하여 로컬 환경에 Elasticsearch와 Kibana를 구성하고, RAG 시스템의 Vector DB로 활용하는 방법을 습득합니다.

---

## 목차

1. [개요](#1-개요)
2. [Elasticsearch 개념과 특징](#2-elasticsearch-개념과-특징)
3. [Kibana 개념과 특징](#3-kibana-개념과-특징)
4. [Docker를 사용한 개별 설치](#4-docker를-사용한-개별-설치)
5. [Docker Compose를 활용한 통합 관리](#5-docker-compose를-활용한-통합-관리)
6. [실전 활용 예제](#6-실전-활용-예제)
7. [문제 해결](#7-문제-해결)

---

## 1. 개요

### 1.1 왜 Elasticsearch를 Vector DB로 사용하나?

**RAG (Retrieval-Augmented Generation)** 시스템에서 Elasticsearch는 강력한 Vector DB로 활용됩니다.

```
┌─────────────────────────────────────────────────┐
│  RAG 시스템 아키텍처                             │
├─────────────────────────────────────────────────┤
│                                                 │
│  1. 문서 수집                                   │
│     ↓                                           │
│  2. 임베딩 생성 (벡터화)                        │
│     ↓                                           │
│  3. Elasticsearch에 저장  ← Vector DB           │
│     ↓                                           │
│  4. 쿼리 → 벡터 검색                            │
│     ↓                                           │
│  5. 관련 문서 검색                              │
│     ↓                                           │
│  6. LLM에 컨텍스트 제공                         │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 1.2 Elasticsearch의 강점

| 강점 | 설명 |
|------|------|
| **하이브리드 검색** | 키워드 검색 + 벡터 검색 동시 지원 |
| **확장성** | 수평 확장 가능 (샤딩) |
| **실시간 검색** | Near real-time 검색 |
| **RESTful API** | 쉬운 통합 |
| **Kibana 연동** | 강력한 시각화 도구 |

### 1.3 학습 환경

```
로컬 개발 환경:
- Docker Desktop 설치
- Elasticsearch 8.x
- Kibana 8.x
- Docker Compose
```

---

## 2. Elasticsearch 개념과 특징

### 2.1 Elasticsearch란?

**Elasticsearch**는 Apache Lucene 기반의 오픈소스 분산 검색 및 분석 엔진입니다.

```
전통적인 DB vs Elasticsearch

┌──────────────────────┐    ┌──────────────────────┐
│  Traditional DB      │    │  Elasticsearch       │
├──────────────────────┤    ├──────────────────────┤
│  Database            │    │  Index               │
│  Table               │    │  Type (deprecated)   │
│  Row                 │    │  Document            │
│  Column              │    │  Field               │
│  Schema              │    │  Mapping             │
└──────────────────────┘    └──────────────────────┘
```

### 2.2 주요 개념

#### 2.2.1 Index (인덱스)
- 비슷한 특성을 가진 문서들의 모음
- RDB의 Database와 유사

```json
// 인덱스 예시
{
  "index_name": "documents",
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0
  }
}
```

#### 2.2.2 Document (문서)
- 인덱싱할 수 있는 기본 정보 단위
- JSON 형식

```json
{
  "_index": "documents",
  "_id": "1",
  "_source": {
    "title": "Elasticsearch 가이드",
    "content": "Elasticsearch는 강력한 검색 엔진입니다.",
    "embedding": [0.23, -0.45, 0.12, ...],  // 768차원 벡터
    "timestamp": "2024-10-24T10:00:00Z"
  }
}
```

#### 2.2.3 Mapping (매핑)
- 문서의 필드와 타입을 정의
- RDB의 스키마와 유사

```json
{
  "mappings": {
    "properties": {
      "title": { "type": "text" },
      "content": { "type": "text" },
      "embedding": {
        "type": "dense_vector",
        "dims": 768
      },
      "timestamp": { "type": "date" }
    }
  }
}
```

### 2.3 Elasticsearch의 특징

#### 특징 1: 분산 아키텍처
```
┌─────────┐  ┌─────────┐  ┌─────────┐
│ Node 1  │  │ Node 2  │  │ Node 3  │
│ Shard 1 │  │ Shard 2 │  │ Shard 3 │
│ Replica │  │ Replica │  │ Replica │
└─────────┘  └─────────┘  └─────────┘
```

#### 특징 2: Near Real-time (NRT)
- 문서 인덱싱 후 1초 이내 검색 가능
- Refresh 주기 조절 가능

#### 특징 3: RESTful API
```bash
# 문서 추가
PUT /documents/_doc/1
{
  "title": "Sample Document",
  "content": "This is a test."
}

# 검색
GET /documents/_search
{
  "query": {
    "match": { "content": "test" }
  }
}
```

### 2.4 Vector Search 지원

Elasticsearch 8.x부터 강력한 벡터 검색 지원:

```json
{
  "query": {
    "script_score": {
      "query": { "match_all": {} },
      "script": {
        "source": "cosineSimilarity(params.query_vector, 'embedding') + 1.0",
        "params": {
          "query_vector": [0.23, -0.45, 0.12, ...]
        }
      }
    }
  }
}
```

또는 8.0+의 `knn` 쿼리:

```json
{
  "knn": {
    "field": "embedding",
    "query_vector": [0.23, -0.45, 0.12, ...],
    "k": 10,
    "num_candidates": 100
  }
}
```

---

## 3. Kibana 개념과 특징

### 3.1 Kibana란?

**Kibana**는 Elasticsearch를 위한 오픈소스 데이터 시각화 및 탐색 도구입니다.

```
Kibana의 역할:
┌─────────────────────────────────────┐
│  사용자                              │
│   ↓ (웹 브라우저)                   │
│  Kibana (UI)                        │
│   ↓ (REST API)                      │
│  Elasticsearch (데이터)             │
└─────────────────────────────────────┘
```

### 3.2 주요 기능

#### 3.2.1 Discover (탐색)
- 실시간 데이터 탐색
- 필터링 및 검색
- 타임라인 분석

#### 3.2.2 Visualize (시각화)
- 다양한 차트 생성
- 맵, 그래프, 테이블
- 커스텀 시각화

#### 3.2.3 Dashboard (대시보드)
- 여러 시각화를 하나로 통합
- 실시간 모니터링
- 인터랙티브 필터

#### 3.2.4 Dev Tools (개발 도구)
- Console: Elasticsearch API 테스트
- Profiler: 쿼리 성능 분석
- Grok Debugger: 로그 파싱 테스트

### 3.3 Kibana의 강점

| 강점 | 설명 |
|------|------|
| **직관적 UI** | 코드 없이 데이터 탐색 |
| **실시간 분석** | Live 데이터 모니터링 |
| **Dev Console** | API 테스트 및 디버깅 |
| **플러그인** | 확장 가능한 아키텍처 |
| **보안** | 인증 및 권한 관리 |

---

## 4. Docker를 사용한 개별 설치

### 4.1 사전 준비

#### 4.1.1 Docker 설치 확인

```bash
# Docker 버전 확인
docker --version
# Docker version 24.0.0, build ...

# Docker 실행 확인
docker ps
# CONTAINER ID   IMAGE   COMMAND   CREATED   STATUS   PORTS   NAMES
```

#### 4.1.2 Docker 네트워크 생성

Elasticsearch와 Kibana가 통신할 수 있도록 네트워크를 생성합니다.

```bash
# elastic이라는 이름의 네트워크 생성
docker network create elastic
```

**출력:**
```
7f8a9b2c1d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9
```

**확인:**
```bash
docker network ls
```

**출력:**
```
NETWORK ID     NAME      DRIVER    SCOPE
7f8a9b2c1d3e   elastic   bridge    local
```

### 4.2 Elasticsearch 컨테이너 생성

#### 4.2.1 Docker 이미지 Pull

```bash
# Elasticsearch 8.11.0 이미지 다운로드
docker pull docker.elastic.co/elasticsearch/elasticsearch:8.11.0
```

**출력:**
```
8.11.0: Pulling from elasticsearch/elasticsearch
a2abf6c4d29d: Pull complete
4c0a5df5cfd7: Pull complete
...
Digest: sha256:abc123...
Status: Downloaded newer image for docker.elastic.co/elasticsearch/elasticsearch:8.11.0
docker.elastic.co/elasticsearch/elasticsearch:8.11.0
```

**확인:**
```bash
docker images | grep elasticsearch
```

**출력:**
```
docker.elastic.co/elasticsearch/elasticsearch   8.11.0    a1b2c3d4e5f6   2 weeks ago   1.38GB
```

#### 4.2.2 Elasticsearch 컨테이너 생성 및 실행

```bash
docker run -d \
  --name elasticsearch \
  --net elastic \
  -p 9200:9200 \
  -p 9300:9300 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  -e "xpack.security.http.ssl.enabled=false" \
  docker.elastic.co/elasticsearch/elasticsearch:8.11.0
```

**명령어 설명:**
- `-d`: 백그라운드 실행
- `--name elasticsearch`: 컨테이너 이름
- `--net elastic`: elastic 네트워크 사용
- `-p 9200:9200`: HTTP API 포트
- `-p 9300:9300`: 노드 간 통신 포트
- `-e "discovery.type=single-node"`: 단일 노드 모드
- `-e "xpack.security.enabled=false"`: 보안 기능 비활성화 (개발용)
- `-e "xpack.security.http.ssl.enabled=false"`: SSL 비활성화 (개발용)

**출력:**
```
9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b
```

**실행 확인:**
```bash
docker ps
```

**출력:**
```
CONTAINER ID   IMAGE                                                  COMMAND                  CREATED         STATUS         PORTS                                            NAMES
9a8b7c6d5e4f   docker.elastic.co/elasticsearch/elasticsearch:8.11.0   "/bin/tini -- /usr/l…"   10 seconds ago  Up 8 seconds   0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp   elasticsearch
```

**로그 확인:**
```bash
docker logs elasticsearch
```

**출력 (일부):**
```
[2024-10-24T10:00:00,000][INFO ][o.e.n.Node               ] [elasticsearch] version[8.11.0]
[2024-10-24T10:00:05,000][INFO ][o.e.n.Node               ] [elasticsearch] started
[2024-10-24T10:00:05,500][INFO ][o.e.c.s.ClusterApplierService] [elasticsearch] master node changed
```

#### 4.2.3 Elasticsearch 연결 확인

**방법 1: curl 사용**
```bash
curl http://localhost:9200
```

**출력:**
```json
{
  "name" : "elasticsearch",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "abc123...",
  "version" : {
    "number" : "8.11.0",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "...",
    "build_date" : "2024-01-15T...",
    "build_snapshot" : false,
    "lucene_version" : "9.8.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}
```

**방법 2: 웹 브라우저**
```
http://localhost:9200
```

**방법 3: Python으로 확인**
```python
from elasticsearch import Elasticsearch

es = Elasticsearch(['http://localhost:9200'])
info = es.info()

print(f"Cluster Name: {info['cluster_name']}")
print(f"Version: {info['version']['number']}")
```

**출력:**
```
Cluster Name: docker-cluster
Version: 8.11.0
```

### 4.3 Kibana 컨테이너 생성

#### 4.3.1 Docker 이미지 Pull

```bash
# Kibana 8.11.0 이미지 다운로드
docker pull docker.elastic.co/kibana/kibana:8.11.0
```

**출력:**
```
8.11.0: Pulling from kibana/kibana
a2abf6c4d29d: Already exists
...
Digest: sha256:def456...
Status: Downloaded newer image for docker.elastic.co/kibana/kibana:8.11.0
docker.elastic.co/kibana/kibana:8.11.0
```

#### 4.3.2 Kibana 컨테이너 생성 및 실행

```bash
docker run -d \
  --name kibana \
  --net elastic \
  -p 5601:5601 \
  -e "ELASTICSEARCH_HOSTS=http://elasticsearch:9200" \
  docker.elastic.co/kibana/kibana:8.11.0
```

**명령어 설명:**
- `-d`: 백그라운드 실행
- `--name kibana`: 컨테이너 이름
- `--net elastic`: elastic 네트워크 사용
- `-p 5601:5601`: Kibana 웹 UI 포트
- `-e "ELASTICSEARCH_HOSTS=..."`: Elasticsearch 연결 주소

**출력:**
```
8c7d6e5f4a3b2c1d0e9f8a7b6c5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0a9b8c7
```

**실행 확인:**
```bash
docker ps
```

**출력:**
```
CONTAINER ID   IMAGE                                           PORTS                    NAMES
8c7d6e5f4a3b   docker.elastic.co/kibana/kibana:8.11.0          0.0.0.0:5601->5601/tcp   kibana
9a8b7c6d5e4f   docker.elastic.co/elasticsearch/elasticsearch   0.0.0.0:9200->9200/tcp   elasticsearch
```

**로그 확인:**
```bash
docker logs -f kibana
```

**출력 (일부):**
```
[2024-10-24T10:01:00.000][INFO ][plugins-service] Plugin initialization started
[2024-10-24T10:01:30.000][INFO ][http.server.Preboot] http server running at http://0.0.0.0:5601
[2024-10-24T10:02:00.000][INFO ][status] Kibana is now available
```

#### 4.3.3 Kibana 연결 확인

**웹 브라우저로 접속:**
```
http://localhost:5601
```

**Kibana 홈 화면이 표시되면 성공!**

**Dev Tools Console 접속:**
```
http://localhost:5601/app/dev_tools#/console
```

**Console에서 테스트:**
```
GET /
```

**응답:**
```json
{
  "name": "elasticsearch",
  "cluster_name": "docker-cluster",
  "version": {
    "number": "8.11.0"
  }
}
```

---

## 5. Docker Compose를 활용한 통합 관리

### 5.1 Docker Compose란?

**Docker Compose**는 여러 컨테이너를 정의하고 실행하기 위한 도구입니다.

#### 개별 Docker 명령어의 문제점

```bash
# 네트워크 생성
docker network create elastic

# Elasticsearch 실행
docker run -d --name elasticsearch --net elastic -p 9200:9200 ...

# Kibana 실행
docker run -d --name kibana --net elastic -p 5601:5601 ...

# 문제점:
# - 명령어가 길고 복잡
# - 실수하기 쉬움
# - 재실행 시 매번 타이핑
# - 설정 관리 어려움
```

#### Docker Compose의 장점

```yaml
# docker-compose.yml 하나로 모든 설정 관리
services:
  elasticsearch:
    # ...
  kibana:
    # ...

# 실행: 단 한 줄!
docker-compose up -d
```

### 5.2 Docker Compose 개념

```
┌─────────────────────────────────────────────────┐
│  docker-compose.yml                             │
├─────────────────────────────────────────────────┤
│                                                 │
│  services:                                      │
│    ├─ elasticsearch                             │
│    │   ├─ image                                 │
│    │   ├─ ports                                 │
│    │   └─ environment                           │
│    │                                            │
│    └─ kibana                                    │
│        ├─ image                                 │
│        ├─ ports                                 │
│        ├─ environment                           │
│        └─ depends_on: [elasticsearch]          │
│                                                 │
│  networks:                                      │
│    └─ elastic                                   │
│                                                 │
│  volumes:                                       │
│    └─ es-data                                   │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 5.3 Docker Compose 파일 작성

#### 5.3.1 기본 구성

**파일명: `docker-compose.yml`**

```yaml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - elastic
    volumes:
      - es-data:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    networks:
      - elastic
    depends_on:
      - elasticsearch

networks:
  elastic:
    driver: bridge

volumes:
  es-data:
    driver: local
```

#### 5.3.2 프로덕션 구성 (보안 강화)

```yaml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ELASTIC_PASSWORD=changeme  # 실제 환경에서는 강력한 비밀번호 사용
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=true
      - xpack.security.http.ssl.key=certs/elasticsearch.key
      - xpack.security.http.ssl.certificate=certs/elasticsearch.crt
      - xpack.security.http.ssl.certificate_authorities=certs/ca.crt
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    ports:
      - "9200:9200"
    networks:
      - elastic
    volumes:
      - es-data:/usr/share/elasticsearch/data
      - ./certs:/usr/share/elasticsearch/config/certs:ro
    ulimits:
      memlock:
        soft: -1
        hard: -1

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=https://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=changeme
      - ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES=config/certs/ca.crt
    ports:
      - "5601:5601"
    networks:
      - elastic
    volumes:
      - ./certs:/usr/share/kibana/config/certs:ro
    depends_on:
      - elasticsearch

networks:
  elastic:
    driver: bridge

volumes:
  es-data:
    driver: local
```

### 5.4 Docker Compose 사용법

#### 5.4.1 컨테이너 시작

```bash
# 현재 디렉토리의 docker-compose.yml 사용
docker-compose up -d
```

**출력:**
```
Creating network "cto_elastic" with driver "bridge"
Creating volume "cto_es-data" with local driver
Creating elasticsearch ... done
Creating kibana        ... done
```

**확인:**
```bash
docker-compose ps
```

**출력:**
```
      Name                    Command               State                    Ports
-----------------------------------------------------------------------------------------------------
elasticsearch   /bin/tini -- /usr/local/bi ...   Up      0.0.0.0:9200->9200/tcp, 0.0.0.0:9300->9300/tcp
kibana          /bin/tini -- /usr/local/bi ...   Up      0.0.0.0:5601->5601/tcp
```

#### 5.4.2 로그 확인

```bash
# 모든 서비스 로그
docker-compose logs

# 특정 서비스 로그
docker-compose logs elasticsearch
docker-compose logs kibana

# 실시간 로그 (-f: follow)
docker-compose logs -f

# 최근 100줄만
docker-compose logs --tail=100
```

#### 5.4.3 컨테이너 중지

```bash
# 중지 (컨테이너 유지)
docker-compose stop

# 중지 후 컨테이너 삭제
docker-compose down

# 볼륨까지 삭제 (데이터 삭제!)
docker-compose down -v
```

#### 5.4.4 컨테이너 재시작

```bash
# 모든 서비스 재시작
docker-compose restart

# 특정 서비스만 재시작
docker-compose restart elasticsearch
```

#### 5.4.5 컨테이너 내부 접속

```bash
# Elasticsearch 컨테이너 접속
docker-compose exec elasticsearch bash

# Kibana 컨테이너 접속
docker-compose exec kibana bash
```

### 5.5 Docker Compose 주요 명령어

| 명령어 | 설명 |
|--------|------|
| `docker-compose up -d` | 백그라운드로 시작 |
| `docker-compose down` | 중지 및 삭제 |
| `docker-compose ps` | 컨테이너 상태 확인 |
| `docker-compose logs` | 로그 확인 |
| `docker-compose exec <service> <command>` | 명령 실행 |
| `docker-compose restart` | 재시작 |
| `docker-compose pull` | 이미지 업데이트 |
| `docker-compose build` | 이미지 빌드 |

---

## 6. 실전 활용 예제

### 6.1 인덱스 생성 (벡터 검색용)

#### 6.1.1 Kibana Dev Tools Console에서

```
PUT /documents
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0
  },
  "mappings": {
    "properties": {
      "title": {
        "type": "text"
      },
      "content": {
        "type": "text"
      },
      "embedding": {
        "type": "dense_vector",
        "dims": 768,
        "index": true,
        "similarity": "cosine"
      },
      "metadata": {
        "properties": {
          "source": { "type": "keyword" },
          "author": { "type": "keyword" },
          "created_at": { "type": "date" }
        }
      }
    }
  }
}
```

**응답:**
```json
{
  "acknowledged": true,
  "shards_acknowledged": true,
  "index": "documents"
}
```

#### 6.1.2 Python에서

```python
from elasticsearch import Elasticsearch

es = Elasticsearch(['http://localhost:9200'])

# 인덱스 생성
index_config = {
    "settings": {
        "number_of_shards": 1,
        "number_of_replicas": 0
    },
    "mappings": {
        "properties": {
            "title": {"type": "text"},
            "content": {"type": "text"},
            "embedding": {
                "type": "dense_vector",
                "dims": 768,
                "index": True,
                "similarity": "cosine"
            },
            "metadata": {
                "properties": {
                    "source": {"type": "keyword"},
                    "author": {"type": "keyword"},
                    "created_at": {"type": "date"}
                }
            }
        }
    }
}

response = es.indices.create(index='documents', body=index_config)
print(response)
```

### 6.2 문서 인덱싱

#### 6.2.1 단일 문서

```python
from sentence_transformers import SentenceTransformer
from elasticsearch import Elasticsearch
from datetime import datetime

# 임베딩 모델 로드
model = SentenceTransformer('jhgan/ko-sroberta-multitask')

# Elasticsearch 연결
es = Elasticsearch(['http://localhost:9200'])

# 문서 데이터
document = {
    "title": "Elasticsearch 가이드",
    "content": "Elasticsearch는 강력한 검색 엔진입니다.",
    "metadata": {
        "source": "docs",
        "author": "Bern",
        "created_at": datetime.now().isoformat()
    }
}

# 임베딩 생성
text_to_embed = f"{document['title']} {document['content']}"
embedding = model.encode(text_to_embed).tolist()
document['embedding'] = embedding

# 인덱싱
response = es.index(index='documents', id='1', document=document)
print(f"Result: {response['result']}")  # created
```

#### 6.2.2 대량 문서 (Bulk API)

```python
from elasticsearch import Elasticsearch, helpers

es = Elasticsearch(['http://localhost:9200'])
model = SentenceTransformer('jhgan/ko-sroberta-multitask')

# 대량 문서
documents = [
    {"title": "문서 1", "content": "내용 1"},
    {"title": "문서 2", "content": "내용 2"},
    {"title": "문서 3", "content": "내용 3"},
    # ... 수천 개
]

# Bulk 인덱싱용 데이터 준비
def generate_actions():
    for i, doc in enumerate(documents):
        text = f"{doc['title']} {doc['content']}"
        embedding = model.encode(text).tolist()

        yield {
            "_index": "documents",
            "_id": i,
            "_source": {
                "title": doc['title'],
                "content": doc['content'],
                "embedding": embedding,
                "metadata": {
                    "source": "bulk_import",
                    "created_at": datetime.now().isoformat()
                }
            }
        }

# Bulk 인덱싱 실행
success, failed = helpers.bulk(
    es,
    generate_actions(),
    chunk_size=500,
    request_timeout=30
)

print(f"Indexed {success} documents")
print(f"Failed {len(failed)} documents")
```

### 6.3 벡터 검색

#### 6.3.1 KNN 검색

```python
# 쿼리 텍스트
query_text = "검색 엔진에 대해 알려줘"

# 쿼리 임베딩
query_embedding = model.encode(query_text).tolist()

# KNN 검색
response = es.search(
    index='documents',
    body={
        "knn": {
            "field": "embedding",
            "query_vector": query_embedding,
            "k": 5,
            "num_candidates": 100
        },
        "_source": ["title", "content", "metadata"]
    }
)

# 결과 출력
for hit in response['hits']['hits']:
    print(f"Score: {hit['_score']:.4f}")
    print(f"Title: {hit['_source']['title']}")
    print(f"Content: {hit['_source']['content'][:100]}...")
    print("---")
```

#### 6.3.2 하이브리드 검색 (키워드 + 벡터)

```python
# 하이브리드 검색: 키워드 매칭 + 벡터 유사도
response = es.search(
    index='documents',
    body={
        "query": {
            "bool": {
                "should": [
                    # 키워드 검색
                    {
                        "multi_match": {
                            "query": query_text,
                            "fields": ["title^2", "content"],
                            "type": "best_fields"
                        }
                    },
                    # 벡터 검색
                    {
                        "script_score": {
                            "query": {"match_all": {}},
                            "script": {
                                "source": "cosineSimilarity(params.query_vector, 'embedding') + 1.0",
                                "params": {
                                    "query_vector": query_embedding
                                }
                            }
                        }
                    }
                ]
            }
        },
        "size": 10
    }
)
```

### 6.4 Kibana에서 데이터 시각화

#### 6.4.1 Index Pattern 생성

1. Kibana 접속: `http://localhost:5601`
2. **Management** → **Stack Management** 클릭
3. **Kibana** → **Index Patterns** 클릭
4. **Create index pattern** 클릭
5. Index pattern name: `documents*`
6. Time field: `metadata.created_at`
7. **Create index pattern** 클릭

#### 6.4.2 Discover에서 데이터 탐색

1. **Analytics** → **Discover** 클릭
2. Index pattern 선택: `documents`
3. Time range 설정
4. 검색 쿼리 입력:
   ```
   content: "검색"
   ```
5. 필터 추가:
   ```
   metadata.source: "docs"
   ```

#### 6.4.3 시각화 생성

1. **Analytics** → **Visualize** 클릭
2. **Create visualization** 클릭
3. 시각화 유형 선택 (예: Pie chart)
4. Metrics 설정:
   - Metric: Count
5. Buckets 설정:
   - Aggregation: Terms
   - Field: `metadata.source.keyword`
6. **Save** 클릭

---

## 7. 문제 해결

### 7.1 일반적인 오류

#### 오류 1: Elasticsearch가 시작되지 않음

**증상:**
```bash
docker logs elasticsearch
# OutOfMemoryError
```

**원인:** 메모리 부족

**해결:**
```yaml
# docker-compose.yml
environment:
  - "ES_JAVA_OPTS=-Xms512m -Xmx512m"  # 메모리 제한
```

#### 오류 2: Kibana가 Elasticsearch에 연결 못함

**증상:**
```
Unable to retrieve version information from Elasticsearch nodes
```

**원인:** 네트워크 설정 오류

**해결:**
```yaml
# docker-compose.yml
kibana:
  environment:
    - ELASTICSEARCH_HOSTS=http://elasticsearch:9200  # 컨테이너 이름 사용
  depends_on:
    - elasticsearch
```

#### 오류 3: 포트 이미 사용 중

**증상:**
```
Error starting userland proxy: listen tcp4 0.0.0.0:9200: bind: address already in use
```

**해결:**
```bash
# 포트 사용 중인 프로세스 확인
netstat -ano | findstr :9200

# 프로세스 종료 또는 다른 포트 사용
ports:
  - "19200:9200"  # 호스트 포트 변경
```

### 7.2 성능 최적화

#### 최적화 1: 메모리 설정

```yaml
environment:
  # 힙 메모리: 전체 메모리의 50% 이하
  - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
```

#### 최적화 2: 샤드 설정

```json
{
  "settings": {
    "number_of_shards": 1,      // 작은 인덱스는 1개
    "number_of_replicas": 0,    // 로컬 개발은 0
    "refresh_interval": "30s"   // 실시간 불필요하면 증가
  }
}
```

#### 최적화 3: 벌크 인덱싱

```python
# 작은 배치보다 큰 배치가 효율적
helpers.bulk(es, actions, chunk_size=1000)  # 500-1000 권장
```

### 7.3 데이터 백업 및 복구

#### 스냅샷 생성

```bash
# 스냅샷 리포지토리 등록
PUT /_snapshot/my_backup
{
  "type": "fs",
  "settings": {
    "location": "/usr/share/elasticsearch/backup"
  }
}

# 스냅샷 생성
PUT /_snapshot/my_backup/snapshot_1
{
  "indices": "documents",
  "include_global_state": false
}
```

#### 복구

```bash
# 스냅샷 복구
POST /_snapshot/my_backup/snapshot_1/_restore
```

---

## 정리

### 핵심 요약

1. **Elasticsearch**
   - 분산 검색 엔진
   - Vector DB로 활용 가능
   - RESTful API 제공

2. **Kibana**
   - 시각화 도구
   - Dev Console로 API 테스트
   - 실시간 모니터링

3. **Docker Compose**
   - 다중 컨테이너 관리
   - YAML로 설정 정의
   - 간편한 시작/중지

4. **RAG 활용**
   - 문서 임베딩 저장
   - 벡터 유사도 검색
   - 하이브리드 검색

### 명령어 요약

```bash
# Docker Compose 시작
docker-compose up -d

# 로그 확인
docker-compose logs -f

# 중지
docker-compose down

# Elasticsearch 확인
curl http://localhost:9200

# Kibana 접속
http://localhost:5601
```

### 다음 단계

Elasticsearch와 Kibana 환경이 구성되었다면:

1. ✅ Python 라이브러리 설치 (`elasticsearch`, `sentence-transformers`)
2. ✅ 임베딩 모델로 문서 벡터화
3. ✅ Elasticsearch에 인덱싱
4. ✅ 벡터 검색 구현
5. 🚀 RAG 시스템 구축

---

**문서 버전**: 1.0
**최종 수정일**: 2025-10-24
**작성자**: Bern
